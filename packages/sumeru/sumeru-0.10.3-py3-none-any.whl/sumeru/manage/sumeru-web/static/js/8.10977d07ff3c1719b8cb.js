webpackJsonp([8],{Nuf7:function(t,e){},zWL9:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=s("mvHQ"),i=s.n(a),n=s("pFYg"),r=s.n(n),o=s("BO1k"),l=s.n(o),c=s("INCx"),u=s.n(c),d=s("E5Az"),_=s("X2Oc"),p=(s("zL8q"),s("jGSh"),s("mw3O")),m=s.n(p);s("tWbI");var h=s("xrTZ").Base64,f={components:{codemirror:d.codemirror},name:"task",data:function(){return{log_rolling_loading:!1,currend_id:null,tree_data:[],chartSettings:{seriesMap:{task_tree:{orient:"vertical",nodePadding:30,label:{normal:{position:"left",verticalAlign:"middle",align:"right",color:"#000"}},leaves:{label:{normal:{position:"right",verticalAlign:"middle",align:"left"}}}}}},chartExtend:{tooltip:{alwaysShowContent:!0}},chartData:{columns:["name","value"],rows:[{name:"task_tree",value:[]}]},select_group:null,ws_url:"",wsuri:"",skip_id:-1,websock:null,current_hash_id:"",url:"/api/exectask/list",cmOptions:{tabSize:4,mode:"python",theme:"base16-dark",lineNumbers:!0,line:!0},del_task_id:-1,tableData:[],total:0,page_size:10,cur_page:1,multipleSelection:[],select_cate:this.$route.query.status,select_word:"",del_list:[],is_search:!1,editVisible:!1,newTaskVisible:!1,delVisible:!1,execStatusVisible:!1,logs:"<div  class='sumeru_success'>2018-01-01 10:10:10 [INFO]  正在连接日志输出服务...连接成功</div>  <div  class='sumeru_success'>2018-01-01 10:10:13 [INFO]  开始同步日志</div> <div  class='sumeru_error'> 2017-11-29 07:55:18,422 PassiveScanPlugin.py[line:87] ERROR </div> <div  class='sumeru_success'>2017-11-29 07:55:18,423 plugin.py[line:93] DEBUG | start_thread ins-id : &lt;Thread(Thread-63, started 139666053179136)&gt;</div> ",form:{task_desc:"",task_code:'task={"PLUGIN_NAME":"BashPlugin","PARAM":{"cmd":"ls"}}',task_name:"",group_id:""},idx:-1}},created:function(){this.select_cate=this.$route.query.status,this.getData(),this.getNodeList()},destroyed:function(){clearInterval(this.timer)},computed:{log_msg:function(){return this.log_message},codemirror:function(){return this.$refs.myCm.codemirror},data:function(){var t=this;return this.tableData.filter(function(e){for(var s=!1,a=0;a<t.del_list.length;a++)if(e.name===t.del_list[a].name){s=!0;break}if(!s&&e.address.indexOf(t.select_cate)>-1&&(e.name.indexOf(t.select_word)>-1||e.address.indexOf(t.select_word)>-1))return e})}},filters:{formatDate:function(t){var e=new Date(u()(1e3*t));return Object(_.a)(e,"yyyy-MM-dd HH:mm:ss")},statusFilter:function(t){return{SUCCESS:"success",RUNNING:"primary",FAILURE:"danger",CANCELED:"danger",CANCELING:"info"}[t]},statusNameFilter:function(t){return{SUCCESS:"执行成功",RUNNING:"执行中",FAILURE:"执行失败",CANCELED:"强制停止",CANCELING:"停止中..."}[t]}},methods:{add_scroll_event:function(){var t=this;window.addEventListener("scroll",function(){if(t.$refs.elscrollbar){var e=t.$refs.elscrollbar.$refs.wrap;if(e.scrollTop+e.clientHeight==e.scrollHeight&&e.scrollTop>0&&!t.log_rolling_loading&&t.skip_id>0){t.log_rolling_loading=!0;var s=t.$loading({lock:!0,text:"日志加载中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.75)"});t.$axios.get("api/exectask/log",{params:{id:t.currend_id,skip_id:t.skip_id}}).then(function(e){s.close(),t.skip_id=e.data.skip_id,console.log(t.skip_id),t.log_rolling_loading=!1;var a=!0,i=!1,n=void 0;try{for(var o,c=l()(e.data.result);!(a=(o=c.next()).done);a=!0){var u=o.value;t.logs+=" <div  class='sumeru_warning'>TIME:   "+u.create_time+"</div> ";try{var d=JSON.parse(u.data);for(var _ in d)"ERROR"==_&&d[_]?t.logs+="<span  class='sumeru_success'>"+_+"</span>:<span  class='sumeru_error'>"+d[_]+"</span> , ":"TASK_STATUS"==d.MSG_TYPE?"TASK_ID"!=_&&"RUNNING_STATUS"!=_&&"MSG_TYPE"!=_||(t.logs+="<span  class='sumeru_success'>"+_+"</span>:<span  class='sumeru_white'>"+d[_]+"</span> , "):"object"==r()(d[_])?t.logs+="<span  class='sumeru_success'>"+_+"</span>:<span  class='sumeru_yellow'>"+t.obj2string(d[_])+"</span> , ":t.logs+="<span  class='sumeru_success'>"+_+"</span>:<span  class='sumeru_white'>"+d[_]+"</span> , "}catch(e){var p=u.data;t.logs+="<span  class='sumeru_success'>"+p+"</span>"}}}catch(t){i=!0,n=t}finally{try{!a&&c.return&&c.return()}finally{if(i)throw n}}})}}},!0)},handle_scroll:function(t){t.preventDefault(),console.log(t)},tooltipFormatter:function(t){return t.data.result.agent_name?[,"节点："+t.data.result.agent_name+",地址："+t.data.result.agent_addr,"状态："+t.data.result.status].join("<br>"):["状态："+t.data.result.status].join("<br>")},getDateDiff:function(t){return Object(_.b)(t)},fixn:function(t,e){return void 0==t?0:t.toFixed(e)},formatDate:function(t){var e=new Date(u()(1e3*t));return Object(_.a)(e,"yyyy-MM-dd HH:mm:ss")},getNodeList:function(){var t=this;this.$axios.get("/api/group/list",{params:{status:1}}).then(function(e){t.select_group=e.data.result})},handleExec:function(t,e){var s=this;this.$confirm("是否确认此操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(function(){s.$axios.post("/api/exectask/op",m.a.stringify({op:"exec",id:e.id})).then(function(t){1==t.data.status?s.$message.success(t.data.msg):s.$message.error("任务执行失败, 错误码:"+t.data.status)})}).catch(function(){s.$message({type:"info",message:"操作已取消"})})},contruct_tree:function(t){this.tree_data=[];var e=Array();t.forEach(function(t,s){e.push({name:t.component_name+" - "+t.task_id+"="+t.status,id:t.task_id,children:t.child})}),this.tree_data.push({name:t[0].component_name+" - START:"+this.formatDate(t[0].start_time),id:t[0].task_id,children:e})},update_tree:function(){var t=this;if(this.execStatusVisible){var e=this.$loading({lock:!0,text:"任务树更新中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.75)"});this.$axios.get("api/exectask/result",{params:{id:this.update_tree_row_id}}).then(function(s){"SUCCESS"==s.data.result[0].result.status||"FAILURE"==s.data.result[0].result.status||"CANCELED"==s.data.result[0].result.status||(t.timer=setInterval(function(){clearInterval(t.timer),t.update_tree()},5e3)),t.chartData={columns:["name","value"],rows:[{name:"task_tree",value:[s.data.result]}]},e.close()})}},handleExecStatus:function(t,e){var s=this,a=this.$loading({lock:!0,text:"任务树生成中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.75)"});this.$axios.get("api/exectask/result",{params:{id:e.id}}).then(function(t){s.update_tree_row_id=e.id,s.chartData={columns:["name","value"],rows:[{name:"task_tree",value:[t.data.result]}]},a.close(),s.execStatusVisible=!0,"SUCCESS"==t.data.result[0].result.status||"FAILURE"==t.data.result[0].result.status||"CANCELED"==t.data.result[0].result.status||(s.timer=setInterval(function(){clearInterval(s.timer),s.update_tree()},5e3))})},handleStop:function(t,e){var s=this;this.$confirm("是否确认此操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(function(){s.$axios.post("/api/exectask/op",m.a.stringify({op:"stop",id:e.id})).then(function(t){1==t.data.status?s.$message.success(t.data.msg):s.$message.error("任务执行失败, 错误码:"+t.data.status)})}).catch(function(){s.$message({type:"info",message:"操作已取消"})})},handleRestart:function(t,e){},onCmCodeChange:function(t){this.form.task_code=t},handleCurrentChange:function(t){this.cur_page=t,this.getData()},getData:function(){var t=this;this.$axios.get(this.url,{params:{page_index:this.cur_page,search:this.select_word,running_status:this.select_cate,page_size:this.page_size,crontask_id:this.$route.query.crontask_id?this.$route.query.crontask_id:null}}).then(function(e){t.tableData=e.data.result,t.total=e.data.count})},search:function(){this.getData()},filterTag:function(t,e){return e.tag===t},newTask:function(){this.newTaskVisible=!0},saveNewTask:function(){var t=this;this.newTaskVisible=!1,this.form.task_code=h.encode(this.form.task_code),this.$axios.post("/api/exectask/add",m.a.stringify(this.form)).then(function(e){1==e.data.status?t.$message.success("任务创建成功"):t.$message.error("任务创建失败, 错误码:"+e.data.status)})},handleSizeChange:function(t){this.page_size=t,this.getData()},obj2string:function(t){var e=[];if("string"==typeof t)return'"'+t.replace(/([\'\"\\])/g,"\\$1").replace(/(\n)/g,"\\n").replace(/(\r)/g,"\\r").replace(/(\t)/g,"\\t")+'"';if("object"==(void 0===t?"undefined":r()(t))){if(t.sort){for(s=0;s<t.length;s++)e.push(this.obj2string(t[s]));e="["+e.join()+"]"}else{for(var s in t)e.push(s+":"+this.obj2string(t[s]));document.all&&!/^\n?function\s*toString\(\)\s*\{\n?\s*\[native code\]\n?\s*\}\n?\s*$/.test(t.toString)&&e.push("toString:"+t.toString.toString()),e="{"+e.join()+"}"}return e}return t.toString()},handleDetail:function(t,e){var s=this;console.log(this.$refs),this.currend_id=e.id,e?(this.current_hash_id!=e.id&&(this.logs="<div  class='sumeru_success'>开始接收任务数据 - 任务 ID: "+e.id+"</div>",this.logs+=" <div  class='sumeru_warning'>加载中 ...</div>",this.$axios.get("api/exectask/log",{params:{id:e.id}}).then(function(t){s.skip_id=t.data.skip_id,s.logs+="<div  class='sumeru_warning'>加载完成</div>";var e=!0,a=!1,i=void 0;try{for(var n,o=l()(t.data.result);!(e=(n=o.next()).done);e=!0){var c=n.value;s.add_scroll_event(),s.logs+=" <div  class='sumeru_warning'>TIME:   "+c.create_time+"</div> ";try{var u=JSON.parse(c.data);for(var d in u)"ERROR"==d&&u[d]?s.logs+="<span  class='sumeru_success'>"+d+"</span>:<span  class='sumeru_error'>"+u[d]+"</span> , ":"TASK_STATUS"==u.MSG_TYPE?"TASK_ID"!=d&&"RUNNING_STATUS"!=d&&"MSG_TYPE"!=d||(s.logs+="<span  class='sumeru_success'>"+d+"</span>:<span  class='sumeru_white'>"+u[d]+"</span> , "):"object"==r()(u[d])?s.logs+="<span  class='sumeru_success'>"+d+"</span>:<span  class='sumeru_yellow'>"+s.obj2string(u[d])+"</span> , ":s.logs+="<span  class='sumeru_success'>"+d+"</span>:<span  class='sumeru_white'>"+u[d]+"</span> , "}catch(t){var _=c.data;s.logs+="<span  class='sumeru_success'>"+_+"</span>"}}}catch(t){a=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(a)throw i}}})),this.current_hash_id=e.hash_id):("ALL_TASK"!=this.current_hash_id&&(this.logs="<div  class='sumeru_success'>开始接收任务数据</div>"),this.current_hash_id="ALL_TASK"),this.editVisible=!0},initWebSocket:function(){var t="ws://"+window.location.host+"/api/ws";this.wsuri=t,this.ws_url=t+"/ALL_TASK"},restartWebSocket:function(){this.websock&&this.websock.close(),this.websock=new WebSocket(this.ws_url),this.websock.onopen=this.websocketonopen,this.websock.onerror=this.websocketonerror,this.websock.onmessage=this.websocketonmessage,this.websock.onclose=this.websocketclose},websocketonopen:function(){console.log("WebSocket连接成功")},websocketonerror:function(t){console.log("WebSocket连接发生错误")},websocketonmessage:function(t){console.log(t.data);var e=JSON.parse(t.data);this.logs+="<div  class='sumeru_success'>["+this.formatDate(e.UNIX_TIME)+"] ["+e.PLUGIN_NAME+"]  "+i()(e.DATA)+"</div>"},websocketsend:function(t){this.websock.send(t)},websocketclose:function(t){console.log("WebSocket connection closed ("+t+")")}}},g={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"table"},[s("div",{staticClass:"crumbs"},[s("el-breadcrumb",{attrs:{separator:"/"}},[s("el-breadcrumb-item",[s("i",{staticClass:"el-icon-tickets"}),t._v("任务\n      ")]),t._v(" "),s("el-breadcrumb-item",[t._v("任务状态")])],1)],1),t._v(" "),s("div",{staticClass:"container",on:{"&scroll":function(e){return t.handle_scroll(e)}}},[s("div",{staticClass:"handle-box"},[s("el-select",{staticClass:"handle-select mr10",attrs:{size:"mini",placeholder:"筛选状态"},model:{value:t.select_cate,callback:function(e){t.select_cate=e},expression:"select_cate"}},[s("el-option",{key:"0",attrs:{label:"全部",value:""}}),t._v(" "),s("el-option",{key:"1",attrs:{label:"未开始",value:"PENDING"}}),t._v(" "),s("el-option",{key:"2",attrs:{label:"执行中",value:"RUNNING"}}),t._v(" "),s("el-option",{key:"3",attrs:{label:"执行失败",value:"FAILURE"}}),t._v(" "),s("el-option",{key:"4",attrs:{label:"执行成功",value:"SUCCESS"}}),t._v(" "),s("el-option",{key:"5",attrs:{label:"强制停止",value:"CANCELED"}})],1),t._v(" "),s("el-input",{staticClass:"handle-input mr10",attrs:{size:"mini",placeholder:"筛选关键词"},nativeOn:{keyup:function(e){if(!("button"in e)&&t._k(e.keyCode,"enter",13,e.key,"Enter"))return null;t.search()}},model:{value:t.select_word,callback:function(e){t.select_word=e},expression:"select_word"}}),t._v(" "),s("el-button",{attrs:{size:"mini",type:"primary",icon:"search"},on:{click:t.search}},[t._v("搜索")])],1),t._v(" "),s("el-table",{staticStyle:{width:"100%"},attrs:{data:t.tableData,border:""}},[s("el-table-column",{attrs:{type:"selection",width:"55"}}),t._v(" "),s("el-table-column",{attrs:{prop:"id",label:"ID",width:"60","show-overflow-tooltip":!0}}),t._v(" "),s("el-table-column",{attrs:{prop:"task_name",label:"任务名称"}}),t._v(" "),s("el-table-column",{attrs:{prop:"group_name",label:"分组","min-width":"80","show-overflow-tooltip":!0}}),t._v(" "),s("el-table-column",{attrs:{prop:"layout_name",label:"编排","min-width":"80","show-overflow-tooltip":!0}}),t._v(" "),s("el-table-column",{attrs:{prop:"last_time",label:"耗时"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.finish_time-e.row.start_time>0?t.fixn(e.row.finish_time-e.row.start_time,3):0)+" 秒")]}}])}),t._v(" "),s("el-table-column",{attrs:{prop:"running_status",label:"状态"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-tag",{attrs:{type:t._f("statusFilter")(e.row.running_status)}},[t._v(t._s(t._f("statusNameFilter")(e.row.running_status)))])]}}])}),t._v(" "),s("el-table-column",{attrs:{prop:"start_time",label:"执行时间",width:"150"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(t.getDateDiff(e.row.time_diff)))]}}])}),t._v(" "),s("el-table-column",{attrs:{label:"",width:"200"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-button",{attrs:{size:"mini"},on:{click:function(s){t.handleExecStatus(e.$index,e.row)}}},[t._v("实时")]),t._v(" "),s("el-button",{attrs:{size:"mini"},on:{click:function(s){t.handleDetail(e.$index,e.row)}}},[t._v("日志")])]}}])}),t._v(" "),s("el-table-column",{attrs:{label:"操作",width:"180"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",{directives:[{name:"tooltip",rawName:"v-tooltip",value:"再次执行任务",expression:"'再次执行任务'"}],attrs:{size:"mini"},on:{click:function(s){t.handleExec(e.$index,e.row)}}},[s("i",{staticClass:"el-icon-chongxi iconfont_no_margin sumeru_op_button"})]),t._v(" "),s("span",{directives:[{name:"tooltip",rawName:"v-tooltip",value:"强制终止任务",expression:"'强制终止任务'"}],attrs:{size:"mini"},on:{click:function(s){t.handleStop(e.$index,e.row)}}},[s("i",{staticClass:"el-icon-tingzhi4 iconfont_no_margin sumeru_op_button sumeru_red"})])]}}])})],1),t._v(" "),s("div",{staticClass:"pagination"},[s("el-pagination",{attrs:{"current-page":t.cur_page,"page-sizes":[10,20,50,100],"page-size":t.page_size,layout:"total, sizes, prev, pager, next, jumper",total:t.total},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange,"update:currentPage":function(e){t.cur_page=e},"update:pageSize":function(e){t.page_size=e},"update:total":function(e){t.total=e}}})],1)],1),t._v(" "),s("el-dialog",{attrs:{title:"新建任務",visible:t.newTaskVisible,width:"50%"},on:{"update:visible":function(e){t.newTaskVisible=e}}},[s("el-form",{ref:"form",attrs:{model:t.form,"label-width":"100px"}},[s("el-form-item",{attrs:{label:"任务名称"}},[s("el-input",{attrs:{clearable:""},model:{value:t.form.task_name,callback:function(e){t.$set(t.form,"task_name",e)},expression:"form.task_name"}})],1),t._v(" "),s("el-form-item",{attrs:{label:"任务说明"}},[s("el-input",{attrs:{clearable:""},model:{value:t.form.task_desc,callback:function(e){t.$set(t.form,"task_desc",e)},expression:"form.task_desc"}})],1),t._v(" "),s("el-form-item",{attrs:{label:"执行分组"}},[s("el-select",{attrs:{placeholder:"请选择"},model:{value:t.form.group_id,callback:function(e){t.$set(t.form,"group_id",e)},expression:"form.group_id"}},t._l(t.select_group,function(t){return s("el-option",{key:t.id,attrs:{label:t.group_name,value:t.id}})}))],1),t._v(" "),s("el-form-item",{attrs:{label:"脚本代码"}},[s("codemirror",{attrs:{code:t.form.task_code,options:t.cmOptions},on:{input:t.onCmCodeChange}})],1)],1),t._v(" "),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:function(e){t.newTaskVisible=!1}}},[t._v("取 消")]),t._v(" "),s("el-button",{attrs:{type:"primary"},on:{click:function(e){t.saveNewTask()}}},[t._v("立即执行")])],1)],1),t._v(" "),s("el-dialog",{attrs:{title:"任务执行详情",visible:t.editVisible,width:"70%"},on:{"update:visible":function(e){t.editVisible=e}}},[s("el-form",{ref:"form",attrs:{model:t.form,"label-width":"50px"}},[s("div",{staticClass:"el-card mgb20 is-hover-shadow"},[s("div",{staticClass:"el-card__body",attrs:{id:"logs_console"}},[s("el-scrollbar",{ref:"elscrollbar",staticClass:"h_scrollbar"},[s("div",{domProps:{innerHTML:t._s(t.logs)}},[s("div",{staticClass:"sumeru_success"},[t._v("2018-01-01 10:10:10 [INFO] 正在连接日志输出服务...连接成功")]),t._v(" "),s("div",{staticClass:"sumeru_success"},[t._v("2018-01-01 10:10:13 [INFO] 开始同步日志")]),t._v(" "),s("div",{staticClass:"sumeru_error"},[t._v("2017-11-29 07:55:18,422 PassiveScanPlugin.py[line:87] ERROR")]),t._v(" "),s("div",{staticClass:"sumeru_success"},[t._v("2017-11-29 07:55:18,423 plugin.py[line:93] DEBUG | start_thread ins-id : <Thread(Thread-63, started 139666053179136)>")])])])],1)])]),t._v(" "),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"primary"},on:{click:function(e){t.editVisible=!1}}},[t._v("关 闭")])],1)],1),t._v(" "),s("el-dialog",{attrs:{title:"任务执行状态",visible:t.execStatusVisible,width:"70%",height:"80%"},on:{"update:visible":function(e){t.execStatusVisible=e}}},[s("ve-tree",{attrs:{data:t.chartData,settings:t.chartSettings,extend:t.chartExtend,"tooltip-formatter":t.tooltipFormatter}})],1)],1)},staticRenderFns:[]};var v=s("VU/8")(f,g,!1,function(t){s("Nuf7")},"data-v-4931b48b",null);e.default=v.exports}});