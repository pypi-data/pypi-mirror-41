{% extends 'ccc/campaigns/base.html' %}
{% load tz static staticfiles waffle_tags bootstrap3 %}

{% block title %}{{ request.user.username }} Contacts List
{% endblock title %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'assets/plugins/select2/select2.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'assets/plugins/select2/select2-metronic.css' %}"/>
<!-- END PAGE LEVEL STYLES -->
<style>
    .gridStyle {
        border: 1px solid rgb(212,212,212);
        width: 400px;
        height: 300px
    }
    .highlighted {
        background: #4b8df8;
    }
</style>
{% endblock css %}

{% block content %}
<!-- BEGIN PAGE HEADER-->
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN BREADCRUMB-->
        <ul class="page-breadcrumb breadcrumb">
            <li class="btn-group">
                <span class="primary yellow"> <a href="#basic" data-toggle="modal" class="btn default"> <i class="fa fa-plus"></i> Add Contact <i class="fa fa-user"></i> </a> </span>

                <span class="primary yellow"> <a href="#upload" data-toggle="modal" class="btn default"> <i class="fa fa-plus"></i> Upload Contact - Excel <i class="fa fa-users"></i> </a> </span>

                <span class="primary yellow"> <a href="#import" data-toggle="modal" class="btn default"> <i class="fa fa-plus"></i>Import Contacts <i class="fa fa-cloud-download"></i> </a> </span>

                {% if user.is_staff %}
                <span class="primary yellow"> <a href="#import_users" data-toggle="modal" class="btn btn-warning"> <i class="fa fa-plus"></i>Import System Users <i class="fa fa-gear"></i> </a> </span>
                {% endif %}

            </li>
            <li>
                <i class="fa fa-user"></i>
                <a href="{% url 'contacts' %}">Contacts</a>
            </li>
        </ul>
        <!-- END BREADCRUMB-->
    </div>
</div>
<!-- END PAGE HEADER-->

<div class="row" ng-controller="ContactListController" ng-app="ContactListApp">
    <div class="col-md-12">

        <span class="pull-right"> <a href="{% url 'contact_groups' %}" data-toggle="modal" class="btn btn-info"> <i class="fa fa-group"></i> Manage groups </a> </span>

        <div class="input-group" id="contact_filter">
            <span class="input-group-addon blue-control"><i class="fa fa-bullhorn"></i></span>
            <select name="campaign" class="form-control input-medium" ng-model="camp_id">
                <option value="">All Campaign</option>
                <option value="0">Without Campaign</option>
                {% for campaign in campaigns %}
                <option value="{{ campaign.id }}">{{ campaign }}</option>
                {% endfor %}
            </select>

            <span class="input-group-addon blue-control"><i class="fa fa-group"></i></span>
            <select name="group" class="form-control input-medium" ng-model="group_id" >
                <option value="">All Group</option>
                <option value="0">Without Group</option>
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group }}</option>
                {% endfor %}
            </select>
            <span class="input-group-addon blue-control"><i class="fa fa-mobile"></i></span>
            <select name="survey" class="form-control input-medium" ng-model="survey_id" >
                <option value="">All Survey</option>
                <option value="0">Without Survey</option>
                {% for survey in surveys %}
                <option value="{{ survey.id }}">{{ survey }}</option>
                {% endfor %}
            </select>

        </div>

        <br />
        <div class="col-md-4 input-group">
            <label><b> Type to search on name, number or email</b></label>
            <input ng-model='text_search' class="form-control" type="text" name="search"  ng-model-options='{ debounce: 400 }' change='fetch_contacts_with_campaign_id(camp_id, group_id, "all", text_search)'/>
        </div>

        <div class="col-md-8 input-group" flex-gt-xs>
            <h4>Filter By Date</h4>
            <md-datepicker ng-model="filter_start_date" md-placeholder="Start date"></md-datepicker>
            <md-datepicker ng-model="filter_end_date" md-placeholder="End date"></md-datepicker>
            <button ng-click='fetch_contacts_with_campaign_id(camp_id, group_id, "all", text_search)' type="button" class="btn btn-link btn-success">
                Search
            </button>

            <button ng-click='reset_filters()' type="button" class="btn btn-link btn-success">
                Reset Filters
            </button>

            <button ng-click='fetch_contacts_with_campaign_id(camp_id, group_id, "all", text_search, "export_data")' type="button" class="btn btn-link btn-success">
                Search &amp; Export
            </button>

        </div>

        <!-- BEGIN EXAMPLE TABLE PORTLET-->
        <div class="portlet box blue col-md-12" align="center">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-mobile-phone"></i> Contacts
                </div>
            </div>
            <div class="portlet-body content-loader" ng-init="fetch_contacts()">
                <div>
                    Toggle Columns:
                    <button ng-click="socialToggle = !socialToggle " type="button" class="btn btn-link btn-success">
                        Social
                    </button>

                    <button ng-click="NameToggle = !NameToggle" type="button" class="btn btn-link btn-success">
                        Name
                    </button>
                    <button ng-click="dateCreatedToggle = !dateCreatedToggle" type="button" class="btn btn-link btn-success">
                        Date Created
                    </button>
                    <button ng-click="campaignToggle = !campaignToggle" type="button" class="btn btn-link btn-success">
                        Campaign
                    </button>
                    <button ng-click="groupsToggle = !groupsToggle" type="button" class="btn btn-link btn-success">
                        Groups
                    </button>

                    <button ng-click="surveyToggle = !surveyToggle" type="button" class="btn btn-link btn-success">
                        Survey
                    </button>

                    {% comment %}
                    {% flag "Contact Checkin" %}
                    <button ng-click="checkinsToggle = !checkinsToggle " type="button" class="btn btn-link btn-success">
                        Check-Ins
                    </button>
                    {% endflag %}
                    
                    {% endcomment %}
                    <button ng-click="emailToggle = !emailToggle" type="button" class="btn btn-link btn-success">
                        Email
                    </button>

                    <button ng-click="phoneToggle = !phoneToggle" type="button" class="btn btn-link btn-success">
                        Phone
                    </button>

                    <button ng-click="countryToggle = !countryToggle" type="button" class="btn btn-link btn-success">
                        Country
                    </button>
                    <button ng-click="activeToggle = !activeToggle" type="button" class="btn btn-link btn-success">
                        Active
                    </button>
                    <button ng-click="notesToggle = !notesToggle " type="button" class="btn btn-link btn-success">
                        Notes
                    </button>
                </div>
                <table class="table table-striped table-bordered table-hover" id="sample_2">
                    <thead>
                        <tr>
                            <th style="display: none"></th><!-- hidden column for contact.id -->
                            <th style="display: none"></th><!-- hidden column for campaign id for filtering -->
                            <th style="display: none"></th><!-- hidden column for group id for filtering -->
                            <th><i class="icon-edit"></i></th>
                            <th></th>
                            <th ng-hide="socialToggle">Social</th>
                            <th ng-hide="dateCreatedToggle">Date Created</th>
                            <th ng-hide="NameToggle">Name</th>
                            <th ng-hide="campaignToggle">Campaigns</th>
                            <th ng-hide="groupsToggle">Groups</th>
                            <th ng-hide="surveyToggle">Survey</th>
                            <th ng-hide="emailToggle">Email</th>
                            <th ng-hide="phoneToggle">Phone</th>
                            <th ng-hide="!countryToggle">Country</th>
                            <th ng-hide="!activeToggle">Active</th>
                            <th ng-hide="!notesToggle">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="contact-row" ng-repeat="vc in results.items" >
                            <td style="display: none">{$ vc.id $}</td>
                            <td style="display: none">
                                <spna ng-repeat="id in vc.campaigns_ids">
                                    -{$ id $}-
                                </spna>
                            </td><!-- hidden column for campaign id for filtering -->
                            <td style="display: none">
                                <spna ng-repeat="id in vc.groups_ids">
                                    -{$ id $}-
                                </spna>
                            </td><!-- hidden column for group id for filtering -->
                            <td class="edit-contact">
                                <a class="edit" data-modal-id="#edit_contact_{$ vc.id $}" data-modal-remote="/edit-contact/{$ vc.id $}/"><i class="fa fa-edit"></i></a></td>
                            <td>
                                <a class="delete-contact" href="/delete-contact/{$ vc.id $}/"><i class="fa fa-minus-circle"></i></a>
                            </td>
                            <td ng-hide="socialToggle">
                                <a ng-if='vc.social_profiles.linkedin' title="{$ vc.social_profiles.bio $}" href="{$ vc.social_profiles.linkedin $}" target="_blank">
                                    <i ng-if='vc.social_profiles.linkedin' class="fa fa-linkedin-square"></i>
                                </a>
                                <a ng-if='vc.social_profiles.facebook' title="{$ vc.social_profiles.bio $}" href="{$ vc.social_profiles.facebook $}" target="_blank">
                                    <i ng-if='vc.social_profiles.facebook' class="fa fa-facebook-square"></i>
                                </a>
                                <a ng-if='vc.social_profiles.twitter' title="{$ vc.social_profiles.bio $}" href="{$ vc.social_profiles.twitter $}" target="_blank">
                                    <i ng-if='vc.social_profiles.twitter' class="fa fa-twitter-square"></i>
                                </a>
                                <span class="edit-contact">
                                    <a class="edit" href="javascript:;" ng-if='vc.company_profiles' data-modal-id="#edit_contact_{$ vc.id $}"
                                        data-modal-remote="contacts/{$ vc.id $}/company/{$ vc.company_profiles.id $}/">
                                        <i class="fa fa-building-o"></i>
                                    </a>
                                </span>
                            </td>
                            <td ng-hide="dateCreatedToggle">{$ vc.created_at | date : "MM-dd-y hh:mm:ss a" $}</td>
                            <td ng-hide="NameToggle" class="edit-contact">
                                <a class="edit" href="javascript:;" ng-if="vc.social_profiles" data-modal-id="#edit_contact_{$ vc.id $}"
                                   data-modal-remote="contacts/{$ vc.id $}/social/{$ vc.social_profiles.id $}/">
                                    <span ng-bind-html="vc.first_name|highlight: text_search"></span>&nbsp;
                                    <span ng-bind-html="vc.last_name|highlight: text_search"></span>
                                </a>
                                <div ng-if="!vc.social_profiles">
                                    <span ng-bind-html="vc.first_name|highlight: text_search"></span>&nbsp;
                                    <span ng-bind-html="vc.last_name|highlight: text_search"></span>
                                </div>
                            </td>
                            <td ng-hide="campaignToggle" data-toggle="tooltip" title="{$ vc.campaigns_names $}">
                                <span ng-repeat="name in vc.campaigns_names"> {$ $index + 1 $})  {$ name $}
                                    <br/>
                                </span>
                            </td>
                            <td ng-hide="groupsToggle" data-toggle="tooltip" title="{$ vc.groups_names $}">
                                <span ng-repeat="name in vc.groups_names">{$ name $}
                                    <br/>
                                </span>
                            </td>
                            <td ng-hide="surveyToggle" data-toggle="tooltip" title="{$ vc.surveys_names $}">
                                <span ng-repeat="name in vc.surveys_names">{$ name $}
                                    <br/>
                                </span>
                            </td>
                            <td ng-hide="emailToggle" ng-bind-html="vc.email |highlight: text_search"></td>
                            <td ng-hide="phoneToggle" ng-bind-html="vc.phone |highlight: text_search"></td>
                            <td ng-hide="!countryToggle">{$ vc.country $}</td>
                            <td ng-hide="!activeToggle"><i class="fa  fa-check-circle" style="color:forestgreen"></i> Yes</td>
                            <td ng-hide="!notesToggle" ng-click="$('#contact_note_{$ vc.id $}').modal({remote: '/contact-note/{$ vc.id $}/'})"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr >
                            <span ng-hide="results.api_finished == true"> Searching .... </span>
                        </tr>
                        <tr>
                            <span  ng-show="results.count == 0"> No Results Found </span>
                        </tr>
                        <tr>
                            <th colspan="11"><uib-pagination
                            ng-model="results.currentPage"
                            total-items="results.count"
                            max-size="10"
                            ng-change="results.nextPage(results.currentPage, true)"
                            boundary-links="true"></uib-pagination></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <!-- END EXAMPLE TABLE PORTLET-->
    </div>
    <div ng-repeat="vc in results.items">
        <div id="edit_contact_{$ vc.id $}" class="modal fade edit-contact-modal" tabindex="-1" role="basic" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content"></div>
            </div>
        </div>
    </div>
</div>

{% for vc in contacts %}
<div id="contact_note_{{ vc.id }}" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>
{% endfor %}
{% include 'ccc/contacts/add_contact_modal.inc.html' %}
{% include 'ccc/contacts/upload_contacts_modal.inc.html' with form=upload_contact_form %}
{% include 'ccc/contacts/import_contacts_modal.inc.html' with form=import_contact_form %}
{% if user.is_staff %}
    {% include 'ccc/contacts/import_users_modal.inc.html' with form=import_users_form %}
{% endif %}
{% endblock content %}
{% block scripts %}
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script type="text/javascript" src="{% static 'assets/plugins/select2/select2.min.js' %}"></script>
<script type="text/javascript" src="{% static 'assets/plugins/data-tables/DT_bootstrap.js' %}"></script>
<script type="text/javascript" src="{% static 'angular_apps/contacts/contacts_list.js' %}"></script>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL SCRIPTS -->
<script src="{% static 'assets/scripts/custom/table-advanced.js' %}"></script>
<script src="{% static 'js/jquery.multi-select.js' %}"></script>
<script type="text/javascript" src="{% static 'js/contact.js' %}"></script>
<script>
    jQuery(document).ready(function() {
        TableAdvanced.init(true);
        //first_is_id (it's crazy)
        // Gray-out dropped first column when checked in
        $(document).on('click', '#upload [name=drop_first_row]', function() {
            $('#import-preview tbody tr:first > td').toggleClass("dropped");
        });
        // Store the current value on focus and on change
        $(document).on('focusin', '.col-type-selector', function() {
            $(this).data('prev-val', $(this).val());
        });
        // Remove/add options from other columns upon selecting, and shows/hides custom textbox
        $(document).on('change', '.col-type-selector', function() {
            if ($(this).val() == 'custom') {
                $(this).siblings('input[type=text]').removeClass('hidden');
            } else {
                $(this).siblings('input[type=text]').addClass('hidden');
            }
            console.log("remove hidden class from: " + $(this).data('prev-val'));
            $('[value=' + $(this).val() + '][data-unique]').not($(this).find('option')).attr('hidden', '');
            $('[value=' + $(this).data('prev-val') + '][data-unique]').removeAttr('hidden', '');
        });
        $('#upload').on('shown.bs.modal', function() {
            $('[name="campaigns"]').multiSelect("deselect_all");
            $('[name="groups"]').multiSelect("deselect_all");
        });
    });
    // Used for submitting Create and Edit contact forms via ajax
    $(document).on('submit', '.ajax-contact-form', function(e) {
        e.preventDefault();
        //STOP default action
        $(e.target).find('.submit-form-button').attr("disabled", "disabled");
        var error_div = $(e.target).find('.error');
        error_div.hide().html('');
        $.ajax({
            url : $(e.target).attr("action"),
            type : "POST",
            data : $(e.target).serialize(),
            success : function(response, textStatus, jqXHR) {
                window.location.reload();
            },
            error : function(jqXHR, textStatus, errorThrown) {
                $(e.target).find('.input-group').removeClass('has-error');
                $(e.target).find('.submit-form-button').removeAttr("disabled");
                var response = $.parseJSON(jqXHR.responseText);
                for (var property in response) {
                    if (response.hasOwnProperty(property)) {
                        $(e.target).find('[name=' + property + ']').parents('.input-group').addClass('has-error');
                        for (var i = 0; i < response[property].length; i++) {
                            var error = "<p>" + property + ": " + response[property][i] + "</p>";
                            error_div.append(error);
                        }
                    }
                }
                error_div.show()
            }
        });

    });

    $(document).on('submit', '#upload-contacts-form', function(e) {
        e.preventDefault();
        //STOP default action

        $(e.target).find('.submit-form-button').attr("disabled", "disabled");
        var error_div = $(e.target).find('.error');
        error_div.hide().html('');
        $.ajax({
            url : $(e.target).attr("action"),
            type : "POST",
            data : new FormData($(this)[0]),
            async : false,
            cache : false,
            contentType : false,
            processData : false,
            success : function(response, textStatus, jqXHR) {
                $('#modal-body-table').html(response);
                $('#modal-body-form').hide();
                $('#modal-body-table').show();

                $('#d-form')[0].reset();
                $('#upload-file-info').html('')
                $('#error').html('');
                $('#error_div').hide();
                $('#submit-btn').val('Upload Contacts')
            },
            error : function(jqXHR, textStatus, errorThrown) {
                $(e.target).find('.input-group').removeClass('has-error');
                $(e.target).find('.submit-form-button').removeAttr("disabled");

                var response = $.parseJSON(jqXHR.responseText);
                for (var property in response) {
                    if (response.hasOwnProperty(property)) {
                        $(e.target).find('[name=' + property + ']').parents('.input-group').addClass('has-error');
                        for (var i = 0; i < response[property].length; i++) {
                            var error = "<p>" + property + ": " + response[property][i] + "</p>";
                            error_div.append(error);
                        }
                    }
                }
                error_div.show()
            }
        });

    });

    $(document).ready(function() {

        $(document).on('submit', '#import_preview_form', function(e) {
            e.preventDefault();
            var postData = new FormData($(this)[0]);
            console.log("1");
            var formURL = $(this).attr('action');
            console.log(formURL);
            $('#save-contacts-btn').val(' Saving Contacts ...');
            $('#save-contacts-btn').attr('disabled', 'disabled');

            $.ajax({
                url : formURL,
                type : "POST",
                data : postData,
                dataType : 'html',
                async : false,
                cache : false,
                contentType : false,
                processData : false,
                success : function(response, textStatus, jqXHR) {
                    $('#modal-body-table').html(response);
                },
                error : function(jqXHR, textStatus, errorThrown) {
                    data = $.parseJSON(jqXHR.responseText);
                    $('#error').html(data['message']);
                    $('#error_div').show();

                    $('#save-contacts-btn').val('Save');
                    $('#save-contacts-btn').removeAttr('disabled');
                }
            });

            e.preventDefault();
            //STOP default action
            e.stopImmediatePropagation();

        });

        $(document).on('click', '#upload .close, #close-import-btn', function() {
            $('[name="campaigns"]').multiSelect("deselect_all");
            $('[name="groups"]').multiSelect("deselect_all");
            if ($('#close-import-success').length) {
                location.reload();
            } else {
                $('#upload-contacts-form')[0].reset();
                $('#upload-contacts-form').find('.submit-form-button').removeAttr("disabled");

                $('#upload-file-info').html('')
                $('#error').html('');
                $('#error_div').hide();

                $('#modal-body-table').hide();
                $('#modal-body-form').show();
                $('#modal-body-table').html('');
            }
        });

        $(document).on('click', '#close-import-success', function() {
            location.reload();
        });

        $(document).on('submit', '#add-to-campaign-form, #add-to-group-form', function(e) {
            e.preventDefault();
            //STOP default action

            var data = $(e.target).serialize();
            var filtered_rows = $('#sample_2').dataTable()._('tr', {
                "filter" : "applied"
            });
            filtered_rows.forEach(function(e) {
                data += '&contacts=' + e[0]
            });

            console.log(data);

            $.ajax({
                url : $(e.target).attr("action"),
                type : "POST",
                data : data,
                success : function(response, textStatus, jqXHR) {
                    window.location.reload();
                },
                error : function(jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR.responseText);
                }
            });
        });
    });
    // end doc ready

    // TODO: put these to the base: to make all ajax post csrf protected
    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }


    $.ajaxSetup({
        beforeSend : function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    }); 
</script>
<script type="text/javascript" src="{% static 'js/import_contacts.js' %}"></script>
<script src="https://apis.google.com/js/api.js"></script>

<script type="text/javascript">
    $(function() {
        initMicrosoftAuth('{{ microsoft_client_id }}', '{{ microsoft_redirect_uri }}');

        initYahooAuth();

        // Initialize multi-select on load (for add-contact modal)
        $('.multi-select select[multiple=multiple]').multiSelect({
            selectableHeader : 'Available',
            selectionHeader : 'Selected'
        });
        // Funtion for loading (and initializing) edit-contact modal
        var showEditContactModal = function(e, that) {
            var modal_id = $(that).closest('.edit-contact').children('a').attr('data-modal-id');
            var modal_remote = $(that).closest('.edit-contact').children('a').attr("data-modal-remote");

            // load remote modal
            $(modal_id).modal({}).find('.modal-content').load(modal_remote, function(e, f, g) {
                // Init multi-select
                $(modal_id).find('.multi-select select[multiple=multiple]').multiSelect({
                    selectableHeader : 'Available',
                    selectionHeader : 'Selected'
                });

            });

        };

        // Show edit-contact modal when clicking on the [edit] icon
        $(document).on('click', '.edit-contact', function(e) {
            showEditContactModal(e, this);
        });

        // Show edit-contact modal when double-clicking on a row
        $(document).on('dblclick', '.contact-row', function(e) {
            showEditContactModal(e);
        });

        $('a.toggle-vis').on('click', function(e) {
            e.preventDefault();

            // Get the column API object

            var column = $(this).attr('data-column');
            element = 'td:nth-child(' + column + ')'
            $(element).toggle()
            element = 'th:nth-child(' + column + ')'
            $(element).toggle()

        });

    }); 
</script>

{% endblock scripts %}

